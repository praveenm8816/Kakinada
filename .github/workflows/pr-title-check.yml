name: "Enforce PR Title Pattern for Jira Ticket"

on:
  workflow_call:

permissions:
  pull-requests: write
  contents: read

jobs:
  validate-pr-title:
    runs-on: ubuntu-latest
    steps:
      - name: Check if only CODEOWNERS file changed
        id: codeowners-only
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull_request context. This step must run on a pull_request event.");
              return;
            }
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                per_page: 100
              }
            );
            const changedFiles = files.map(f => f.filename);
            if (changedFiles.length === 1 && changedFiles[0] === 'CODEOWNERS') {
              core.setOutput("only_codeowners", "true");
            } else {
              core.setOutput("only_codeowners", "false");
            }

      - name: Validate PR Title Pattern
        if: steps.codeowners-only.outputs.only_codeowners == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull_request context. This step must run on a pull_request event.");
              return;
            }
            const prTitle = pr.title;
            const jiraPattern = /^CCL-\d+\s.+/;
            if (!jiraPattern.test(prTitle)) {
              const body = "‚ùå **PR title must match `CCL-<number> <description>` (e.g. `CCL-12345 Add feature`).**\n\nPlease update the title to reference an active Jira ticket.";
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body
              });
              core.setFailed("PR title does not match required Jira pattern.");
            }

      - name: Skip check for CODEOWNERS-only PRs
        if: steps.codeowners-only.outputs.only_codeowners == 'true'
        run: echo "Skipping PR title check for CODEOWNERS-only PR."
